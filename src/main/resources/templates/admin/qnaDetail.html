<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>QnA 상세 보기</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/adminqna.css}">
    <!-- jQuery 추가 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function(){
            var chatMessages = $('.chat-messages');
            chatMessages.scrollTop(chatMessages.prop("scrollHeight"));

            // "질문 말풍선" 클릭 시 답변 폼 토글
            $('.question-message').click(function(){
                var qSeq = $(this).data('qseq');
                var replyForm = $('#replyForm_' + qSeq);

                // 현재 클릭된 폼만 토글
                replyForm.toggle();

                // 다른 모든 폼 숨기기
                $('.answer-form-container').not(replyForm).hide();
            });
        });

        // Enter 키로 폼 제출 (각 질문별 폼에 적용)
        function setupEnterKey(formId) {
            document.getElementById(formId).addEventListener('keydown', function (event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault(); // 기본 동작(줄바꿈) 방지
                    this.submit(); // 폼 제출
                }
            });
        }

        // 문서 로드 후 각 폼에 Enter 키 이벤트 리스너 추가
        $(document).ready(function(){
            $('form.answerForm').each(function(index, form){
                setupEnterKey(form.id);
            });
        });
    </script>
</head>
<body>
<!-- 사이드바 -->
<div class="sidebar">
    <div class="QnA-management">
        <h1>QnA 목록</h1>
        <!-- QnA가 없을 경우 -->
        <div th:if="${#lists.isEmpty(userQnaList)}">
            <p>현재 QnA가 없습니다.</p>
        </div>
        <!-- QnA 리스트 -->
        <div th:each="userDto : ${userQnaList}" class="chat-room-item">
            <a th:href="@{/admin/qna/chat/{userId}(userId=${userDto.userId})}">
                <div class="user-info">
                    <span class="user-name" th:text="${userDto.userName}">User Name</span>
                    <span class="last-question-time"
                          th:text="${#temporals.format(userDto.lastQDate, 'yyyy-MM-dd HH:mm')}">
                              마지막 질문 시간
                        </span>
                </div>
                <div class="last-message-preview">
                    <span th:text="${userDto.lastQuestion}">마지막 질문 내용</span>
                </div>
            </a>
        </div>
    </div>
    <a href="#" th:href="@{/admin/main}" class="btn btn-primary">메인으로 돌아가기</a>
</div>

<!-- 채팅 컨테이너 -->
<div class="chat-container">
    <!-- 채팅 헤더 -->
    <div class="chat-header">
        <h1 th:text="${selectedUser.name} + ' 님과의 QnA'">사용자 이름 님과의 QnA</h1>
    </div>

    <!-- 채팅 메시지 영역 -->
    <div class="chat-messages">
        <!-- 질문 및 답변 리스트 -->
        <div th:each="question : ${questions}" class="message-group">
            <!-- 유저 질문 (클릭 가능) -->
            <div class="message right question-message" th:data-qseq="${question.qSeq}">
                <div class="message-content">
                    <p th:text="${question.content}">질문 내용</p>
                    <small th:text="${#temporals.format(question.regDate, 'yyyy-MM-dd HH:mm')}">작성 시간</small>
                </div>
            </div>
            <!-- 답변 리스트 -->
            <div th:each="answer : ${question.answers}" class="message left">
                <div class="message-content">
                    <p th:text="${answer.content}">답변 내용</p>
                    <small th:text="${#temporals.format(answer.regDate, 'yyyy-MM-dd HH:mm')}">작성 시간</small>
                </div>
            </div>
            <!-- 관리자 답변 작성 폼 (숨김 처리) -->
            <div class="chat-input answer-form-container" th:id="'replyForm_' + ${question.qSeq}" style="display: none;">
                <form th:action="@{/admin/qna/answer}" method="post" th:id="'answerForm_' + ${question.qSeq}" class="answerForm">
                    <!-- 질문 ID 전달 -->
                    <input type="hidden" name="qSeq" th:value="${question.qSeq}" />
                    <!-- 답변 내용 입력 -->
                    <textarea name="content" placeholder="답변을 작성하세요..." required></textarea>
                    <!-- 전송 버튼 -->
                    <button type="submit" class="btn btn-primary">전송</button>
                </form>
            </div>
        </div>

        <!-- 질문이 없을 경우 -->
        <div th:if="${#lists.isEmpty(questions)}" class="empty-message">
            <p>아직 질문이 없습니다.</p>
        </div>
    </div>
</div>
</body>
</html>
