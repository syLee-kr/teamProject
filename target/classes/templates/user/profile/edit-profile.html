<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>프로필 수정</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/profile.css}">
</head>
<body>
<div class="sidebar" th:insert="~{user/main/sidebar :: sidebar}"></div>
<div id="main-container" class="main-container">
    <div class="profile-container">
        <form th:action="@{/profile/edit-profile}" method="post" enctype="multipart/form-data" th:object="${user}" class="profile-edit-form">

            <!-- 프로필 이미지 -->
            <div class="profile-image">
                <img th:src="${user.profileImage != null && user.profileImage != 'profileimg.png' ? '/uploadImg/' + user.profileImage : '/images/profileimg.png'}"
                     alt="Profile Image"
                     class="profile-img">
                <label for="profileImageUpload" class="upload-image-label">이미지 변경</label>
                <input type="file" id="profileImageUpload" name="profileImage" class="upload-image-input">
            </div>

            <!-- 프로필 세부정보 -->
            <div class="profile-details">
                <div class="form-group half-width">
                    <label for="name">이름</label>
                    <input type="text" id="name" name="name" th:field="*{name}" required>
                </div>
                <div class="form-group half-width">
                    <label for="gender">성별</label>
                    <select id="gender" name="gender" th:field="*{gender}" required>
                        <option th:value="MALE" th:text="'남성'" />
                        <option th:value="FEMALE" th:text="'여성'" />
                    </select>
                </div>
                <div class="form-group">
                    <label for="phone">전화번호</label>
                    <input type="text" id="phone" name="phone" th:field="*{phone}" required>
                </div>
                <div class="form-group">
                    <label for="address">주소</label>
                    <input type="text" id="address" name="address" placeholder="주소 검색" th:field="*{address}" readonly onclick="openDaumPostcode()" required>
                    <input type="text" id="detailAddress" name="detailAddress" placeholder="상세 주소 입력">
                </div>
                <div class="form-group">
                    <label for="birthday">생년월일</label>
                    <div class="birthday">
                        <select id="birthYear" name="birthYear" required>
                            <option value="" disabled selected>년</option>
                        </select>
                        <select id="birthMonth" name="birthMonth" required>
                            <option value="" disabled selected>월</option>
                        </select>
                        <select id="birthDay" name="birthDay" required>
                            <option value="" disabled selected>일</option>
                        </select>
                        <input type="hidden" id="birthday" name="birthday" th:field="*{birthday}">
                    </div>
                </div>
            </div>

            <!-- 저장 및 취소 버튼 -->
            <div class="profile-actions">
                <button type="submit" class="save-profile-button">저장</button>
                <button type="button" class="cancel-profile-button" onclick="location.href='/profile'">취소</button>
            </div>
        </form>

    </div>
</div>
</body>

<!-- Daum 주소 검색 API -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    // 생년월일 옵션 생성 함수
    function populateBirthYear() {
        const yearSelect = document.getElementById('birthYear');
        const currentYear = new Date().getFullYear();
        const startYear = currentYear - 100; // 100년 전까지 생성
        for (let y = currentYear; y >= startYear; y--) {
            const option = document.createElement('option');
            option.value = y;
            option.text = y;
            yearSelect.appendChild(option);
        }
    }

    function populateBirthMonth() {
        const monthSelect = document.getElementById('birthMonth');
        for (let m = 1; m <= 12; m++) {
            const option = document.createElement('option');
            option.value = m;
            option.text = m;
            monthSelect.appendChild(option);
        }
    }

    function populateBirthDay() {
        const daySelect = document.getElementById('birthDay');
        for (let d = 1; d <= 31; d++) {
            const option = document.createElement('option');
            option.value = d;
            option.text = d;
            daySelect.appendChild(option);
        }
    }

    // Daum 주소 검색 API 호출
    function openDaumPostcode() {
        new daum.Postcode({
            oncomplete: function (data) {
                let roadAddr = data.roadAddress; // 도로명 주소
                let extraAddr = ''; // 참고 항목

                if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                    extraAddr += data.bname;
                }
                if (data.buildingName !== '' && data.apartment === 'Y') {
                    extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                }
                if (extraAddr !== '') {
                    extraAddr = ' (' + extraAddr + ')';
                }

                const fullAddr = roadAddr + extraAddr; // 최종 주소 조합
                document.getElementById('address').value = fullAddr;
                document.getElementById('detailAddress').focus();
            }
        }).open();
    }

    document.addEventListener('DOMContentLoaded', function () {
        // 생년월일 초기화
        populateBirthYear();
        populateBirthMonth();
        populateBirthDay();

        // 사용자 데이터로 생일 필드 설정
        const birthday = document.getElementById('birthday').value;
        if (birthday) {
            const [year, month, day] = birthday.split('-');
            document.getElementById('birthYear').value = year;
            document.getElementById('birthMonth').value = parseInt(month, 10);
            document.getElementById('birthDay').value = parseInt(day, 10);
        }

        // 제출 시 생년월일 형식 설정
        document.querySelector('form').addEventListener('submit', function () {
            const year = document.getElementById('birthYear').value;
            const month = document.getElementById('birthMonth').value.padStart(2, '0');
            const day = document.getElementById('birthDay').value.padStart(2, '0');
            document.getElementById('birthday').value = `${year}-${month}-${day}`;
        });
    });
</script>
</html>
